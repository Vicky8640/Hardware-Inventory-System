{% extends "base.html" %}  
{% load static %}
{% load cart_filters %} 

{% block custom_styles %}
<style>
    .filter-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    /* Style for Profit/Loss column (These should ideally be in base.html if used widely) */
    .profit-positive { color: #198754; font-weight: bold; } 
    .profit-negative { color: #dc3545; font-weight: bold; }
</style>
{% endblock custom_styles %}

{% block title %}Inventory List | {{ SHOP_NAME }}{% endblock %}

{% block content %}

    {% include "inventory/_messages.html" %}

    <div class="row mb-3">
        <div class="col-md-auto">
            <a href="{% url 'add_asset' %}" class="btn btn-primary">
                + Add New Asset
            </a>
        </div>
        <div class="col-md-auto">
            <a href="{% url 'bulk_sale' %}" class="btn btn-success">
                Quick Bulk Sale (Same Type)
            </a>
        </div>
        <div class="col-md-auto">
            <a href="{% url 'start_mixed_sale' %}" class="btn btn-danger">
                Start Mixed Sale (Multi-Item Cart) 
                {% with cart_count=request.session.mixed_sale_assets|length|default:0 %}
                    {% if cart_count > 0 %}
                        <span class="badge text-bg-light">{{ cart_count }}</span>
                    {% endif %}
                {% endwith %}
            </a>
        </div>
    </div>
    
    <div class="filter-section">
    <form method="GET" action="{% url 'asset_list' %}" class="row g-3 align-items-end">
        
        <div class="col-md-4">
            <label for="id_asset_type" class="form-label">Filter by Type</label>
            <select id="id_asset_type" name="asset_type" class="form-select" onchange="this.form.submit()"> 
                <option value="">-- All Types --</option>
                {% for type in ALL_ASSET_TYPES %}
                    <option value="{{ type.pk }}" {% if current_asset_type == type.pk|stringformat:"s" %}selected{% endif %}>
                        {{ type.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="id_status" class="form-label">Filter by Status</label>
            <select id="id_status" name="status" class="form-select" onchange="this.form.submit()">
                <option value="">-- All Statuses --</option>
                {% for key, value in STATUS_CHOICES %}
                    <option value="{{ key }}" {% if current_status == key %}selected{% endif %}>
                        {{ value }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="id_location" class="form-label">Filter by Location</label>
            <select id="id_location" name="location" class="form-select" onchange="this.form.submit()">
                <option value="">-- All Locations --</option>
                {% for key, value in LOCATIONS %}
                    <option value="{{ key }}" {% if current_location == key %}selected{% endif %}>
                        {{ value }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        </form>
</div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Asset ID</th>
                    <th>Type</th>
                    <th>Model</th>
                    <th>Serial Number</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Purchase Price</th>
                    <th>Sale Price</th>
                    <th>Profit/Loss</th>
                    <th>Action</th> 
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for asset in assets %}
                <tr>
                    <td>{{ asset.pk }}</td>
                    <td>{{ asset.asset_type.name }}</td>
                    <td>{{ asset.model_number }}</td>
                    <td>{{ asset.serial_number }}</td>
                    <td>{{ asset.get_location_display }}</td>
                    <td><span class="badge bg-{% if asset.status == 'IN_STOCK' %}info{% elif asset.status == 'PENDING_SALE' %}warning{% else %}success{% endif %}">{{ asset.get_status_display }}</span></td>
                    <td>${{ asset.purchase_price|floatformat:2 }}</td>
                    
                    {% if asset.status == 'SOLD' %}
                        <td>${{ asset.sale_record.sale_price|floatformat:2 }}</td>
                        {% with profit=asset.sale_record.profit_loss %}
                        <td class="{% if profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            ${{ profit|floatformat:2 }}
                        </td>
                        {% endwith %}
                    {% else %}
                        <td>N/A</td>
                        <td>N/A</td>
                    {% endif %}
                    
                    <td>
                        {% if asset.status == 'IN_STOCK' %}
                            {% if asset.pk|stringformat:"s" not in request.session.mixed_sale_assets %}
                                <a href="{% url 'add_to_mixed_sale_from_list' asset_pk=asset.pk %}" class="btn btn-sm btn-success" title="Quick Add to Mixed Sale Cart">
                                    + Add
                                </a>
                            {% else %}
                                <span class="text-success small">In Cart ✔️</span>
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td><a href="{% url 'asset_detail' pk=asset.pk %}" class="btn btn-sm btn-outline-info">View Details</a></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center">No assets found matching the current filters.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

     <nav aria-label="Page navigation" class="d-flex justify-content-center">
        <ul class="pagination">
            {% if assets.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1{{ request|current_query }}">First</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ assets.previous_page_number }}{{ request|current_query }}">Previous</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">First</span></li>
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            <li class="page-item active" aria-current="page">
                <span class="page-link">Page {{ assets.number }} of {{ assets.paginator.num_pages }}</span>
            </li>
            
            {% if assets.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ assets.next_page_number }}{{ request|current_query }}">Next</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ assets.paginator.num_pages }}{{ request|current_query }}">Last</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                <li class="page-item disabled"><span class="page-link">Last</span></li>
            {% endif %}
        </ul>
    </nav>
{% endblock content %}