{% extends "base.html" %} 
{% load static %}
{% load cart_filters %} 
{% load crispy_forms_tags %} 

{% block custom_styles %}
<style>
Â  Â  .filter-section { 
        background-color: #f8f9fa; 
        padding: 10px 15px; /* Tighter vertical spacing */
        border-radius: 5px; 
        margin-bottom: 5px; /* Tighter margin below the filter box */
    }
    
Â  Â  /* Style for Profit/Loss column */
Â  Â  .profit-positive { color: #198754; font-weight: bold; } 
Â  Â  .profit-negative { color: #dc3545; font-weight: bold; }
Â  Â  
Â  Â  /* ğŸ›‘ FIX for Space Issue: Prevents content from stretching vertically ğŸ›‘ */
    .content-area {
        display: flex;
        flex-direction: column;
        min-height: 0; /* Prevents stretching to fill viewport */
    }
    .table-responsive {
        margin-bottom: 0; /* Ensure no extra margin below the table */
    }
    
Â  Â  /* Styling for the Floating Cart Widget */
Â  Â  .floating-cart-widget {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  z-index: 1050; 
Â  Â  Â  Â  transition: opacity 0.3s ease-in-out;
Â  Â  }
</style>
{% endblock custom_styles %}

{% block title %}Inventory List | {{ SHOP_NAME }}{% endblock %}

{% block content %}


Â  Â  <div class="row mb-3">
Â  Â  Â  Â  <div class="col-md-auto">
Â  Â  Â  Â  Â  Â  <a href="{% url 'add_asset' %}" class="btn btn-primary">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="bi bi-plus-circle me-1"></i> + Add New Asset
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col-md-auto">
Â  Â  Â  Â  Â  Â  <a href="{% url 'bulk_sale' %}" class="btn btn-success">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="bi bi-box-seam me-1"></i> Quick Bulk Sale (Same Type)
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  </div>
Â  Â  </div>
    
    <div class="content-area">

        <div class="filter-section p-3 mb-2"> 
            <form method="GET" action="{% url 'asset_list' %}" class="row g-2">
                
                <div class="col-md-3">
                    <select id="id_asset_type" name="asset_type" class="form-select **form-select-sm**" onchange="this.form.submit()"> 
                        <option value="">Filter by Type</option>
                        {% for type in ALL_ASSET_TYPES %}
                            <option value="{{ type.pk }}" {% if current_asset_type == type.pk|stringformat:"s" %}selected{% endif %}>
                                {{ type.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <select id="id_status" name="status" class="form-select **form-select-sm**" onchange="this.form.submit()">
                        <option value="">Filter by Status</option>
                        {% for key, value in STATUS_CHOICES %}
                            <option value="{{ key }}" {% if current_status == key %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <select id="id_location" name="location" class="form-select **form-select-sm**" onchange="this.form.submit()">
                        <option value="">Filter by Location</option>
                        {% for key, value in LOCATIONS %}
                            <option value="{{ key }}" {% if current_location == key %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2 d-grid"> 
                    <a href="{% url 'asset_list' %}" class="btn btn-secondary **btn-sm**">Clear Filters</a>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Asset ID</th>
                        <th>Type</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Purchase Price</th>
                        <th>Sale Price</th>
                        <th>Profit/Loss</th>
                        <th>Action</th> 
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                {% for asset in assets %} 
                    <tr>
                        <td>{{ asset.pk }}</td>
                        <td>{{ asset.asset_type.name }}</td>
                        <td>{{ asset.model_number }}</td>
                        <td>{{ asset.serial_number }}</td>
                        <td>{{ asset.get_location_display }}</td>
                        <td><span class="badge bg-{% if asset.status == 'IN_STOCK' %}info{% elif asset.status == 'PENDING_SALE' %}warning{% else %}success{% endif %}">{{ asset.get_status_display }}</span></td>
                        <td>${{ asset.purchase_price|floatformat:2 }}</td>
                        
                        {% if asset.status == 'SOLD' %}
                            <td>${{ asset.individual_sale_price|floatformat:2 }}</td> 
    
                            {% with profit=asset.profit_loss %} 
                                <td class="{% if profit is not None and profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {% if profit is not None %}${{ profit|floatformat:2 }}{% else %}N/A{% endif %}
                                </td>
                            {% endwith %}
                        {% else %}
                            <td>-</td> 
                            <td>-</td> 
                        {% endif %}
                        
                        <td>
                            {% if asset.status == 'IN_STOCK' %}
                                {% if asset.pk|stringformat:"s" not in request.session.mixed_sale_assets|default:'' %}
                                    <button class="btn btn-sm btn-info add-to-cart-btn" 
                                            data-asset-id="{{ asset.pk }}" 
                                            data-url="{% url 'add_to_mixed_sale' %}"> 
                                        Add to Cart
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-success" disabled>In Cart âœ”ï¸</button>
                                {% endif %} 
                            {% else %}
                                <button class="btn btn-sm btn-secondary" disabled>Unavailable</button>
                            {% endif %} 
                        </td>
                        
                        <td><a href="{% url 'asset_detail' asset_pk=asset.pk %}" class="btn btn-sm btn-outline-info">View Details</a></td>
                    </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center">No assets found matching the current filters.</td>
                </tr>
                {% endfor %} 
                </tbody> 
            </table>
        </div>

    </div> Â  Â  {% if assets.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if assets.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&{{ request.GET.urlencode|cut:'page=' }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">First</span></li>
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                <li class="page-item active" aria-current="page">
                    <span class="page-link">Page {{ assets.number }} of {{ assets.paginator.num_pages }}</span>
                </li>

                {% if assets.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.paginator.num_pages }}&{{ request.GET.urlencode|cut:'page=' }}">Last</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    <li class="page-item disabled"><span class="page-link">Last</span></li>
                {% endif %}
            </ul>
        </nav>
    {% elif assets %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item active"><span class="page-link">Page 1 of 1</span></li>
            </ul>
        </nav>
    {% endif %}


Â  Â  <div class="floating-cart-widget shadow p-2 bg-light rounded-pill d-flex align-items-center" id="floating-cart-widget" 
Â  Â  Â  Â  Â  {% if mixed_sale_count == 0 %}style="opacity: 0; pointer-events: none;"{% endif %}>
Â  Â  Â  Â  <span class="badge bg-danger rounded-pill me-2" id="cart-item-count">{{ mixed_sale_count }}</span>
Â  Â  Â  Â  <span class="me-3">Items for Mixed Sale</span>
Â  Â  Â  Â  <a href="{% url 'finalize_mixed_sale' %}" class="btn btn-sm btn-warning">Finalize Sale</a>
Â  Â  </div>

{% endblock content %} 


{% block extra_js %} 
<script>
Â  Â  // CSRF Token setup for AJAX
Â  Â  // NOTE: The CSRF token needs to be included in your base.html for this to work.
Â  Â  const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
Â  Â  const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  
Â  Â  Â  Â  const cartWidget = document.getElementById('floating-cart-widget');
Â  Â  Â  Â  const cartCount = document.getElementById('cart-item-count');

Â  Â  Â  Â  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
Â  Â  Â  Â  Â  Â  button.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!csrfToken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("CSRF token not found. Cannot perform AJAX request.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const assetId = this.dataset.assetId;
Â  Â  Â  Â  Â  Â  Â  Â  const url = this.dataset.url;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  fetch(url, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'X-CSRFToken': csrfToken,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ asset_pk: assetId })
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update the button state
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.classList.remove('btn-info', 'add-to-cart-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.classList.add('btn-success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.innerHTML = 'In Cart âœ”ï¸';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update the floating cart widget
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartCount.textContent = data.mixed_sale_count;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartWidget.style.opacity = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartWidget.style.pointerEvents = 'auto';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Display a temporary success message
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempMessage = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMessage.className = 'alert alert-success fixed-top m-3';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMessage.textContent = data.message;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(tempMessage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => tempMessage.remove(), 3000); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Error adding asset: ' + data.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error('Error:', error));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });
</script>
{% endblock extra_js %}