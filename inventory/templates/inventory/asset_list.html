{% extends "base.html" %} 
{% load static %}
{% load cart_filters %} 
{% load crispy_forms_tags %} 

{% block custom_styles %}
<style>
¬† ¬† .filter-section { 
        background-color: #f8f9fa; 
        padding: 10px 15px; /* Tighter vertical spacing */
        border-radius: 5px; 
        margin-bottom: 5px; /* Tighter margin below the filter box */
    }
    
¬† ¬† /* Style for Profit/Loss column */
¬† ¬† .profit-positive { color: #198754; font-weight: bold; } 
¬† ¬† .profit-negative { color: #dc3545; font-weight: bold; }
¬† ¬† 
¬† ¬† /* üõë FIX for Space Issue: Prevents content from stretching vertically üõë */
    .content-area {
        display: flex;
        flex-direction: column;
        min-height: 0; /* Prevents stretching to fill viewport */
    }
    .table-responsive {
        margin-bottom: 0; /* Ensure no extra margin below the table */
    }
    
¬† ¬† /* Styling for the Floating Cart Widget */
    /* Styling for the Floating Cart Widget */
    .floating-cart-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050; 
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        
        /* === Enhanced Visibility Styles === */
        padding: 10px 20px !important; 
        background-color: #0d6efd !important; /* Change background to Blue (Primary) */
        color: white; /* White text for high contrast */
        border-radius: 50px !important; /* Fully rounded pill shape */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Stronger shadow */
        transform: scale(1.05); /* Slightly enlarge it to draw attention */
        cursor: pointer; /* Indicate it's interactive */
    }

    /* Style for the badge inside the widget */
    .floating-cart-widget #cart-item-count {
        background-color: #dc3545 !important; /* Red badge for urgency */
        font-size: 1rem;
        font-weight: bold;
    }
</style>
{% endblock custom_styles %}

{% block title %}Inventory List | {{ SHOP_NAME }}{% endblock %}

{% block content %}

    <div class="content-area">

        <div class="filter-section p-3 mb-2"> 
            <form method="GET" action="{% url 'asset_list' %}" class="row g-2">
                
                <div class="col-md-3">
                    <select id="id_asset_type" name="asset_type" class="form-select **form-select-sm**" onchange="this.form.submit()"> 
                        <option value="">Filter by Type</option>
                        {% for type in ALL_ASSET_TYPES %}
                            <option value="{{ type.pk }}" {% if current_asset_type == type.pk|stringformat:"s" %}selected{% endif %}>
                                {{ type.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <select id="id_status" name="status" class="form-select **form-select-sm**" onchange="this.form.submit()">
                        <option value="">Filter by Status</option>
                        {% for key, value in STATUS_CHOICES %}
                            <option value="{{ key }}" {% if current_status == key %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <select id="id_location" name="location" class="form-select **form-select-sm**" onchange="this.form.submit()">
                        <option value="">Filter by Location</option>
                        {% for key, value in LOCATIONS %}
                            <option value="{{ key }}" {% if current_location == key %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2 d-grid"> 
                    <a href="{% url 'asset_list' %}" class="btn btn-secondary **btn-sm**">Clear Filters</a>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Asset ID</th>
                        <th>Type</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Purchase Price</th>
                        <th>Sale Price</th>
                        <th>Profit/Loss</th>
                        <th>Action</th> 
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                {% for asset in assets %} 
                    <tr>
                        <td>{{ asset.pk }}</td>
                        <td>{{ asset.asset_type.name }}</td>
                        <td>{{ asset.model_number }}</td>
                        <td>{{ asset.serial_number }}</td>
                        <td>{{ asset.get_location_display }}</td>
                        <td><span class="badge bg-{% if asset.status == 'IN_STOCK' %}info{% elif asset.status == 'PENDING_SALE' %}warning{% else %}success{% endif %}">{{ asset.get_status_display }}</span></td>
                        <td>${{ asset.purchase_price|floatformat:2 }}</td>
                        
                        {% if asset.status == 'SOLD' %}
                            <td>${{ asset.individual_sale_price|floatformat:2 }}</td> 
    
                            {% with profit=asset.profit_loss %} 
                                <td class="{% if profit is not None and profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {% if profit is not None %}${{ profit|floatformat:2 }}{% else %}N/A{% endif %}
                                </td>
                            {% endwith %}
                        {% else %}
                            <td>-</td> 
                            <td>-</td> 
                        {% endif %}
                        
                        <td>
                            {% if asset.status == 'IN_STOCK' %}
                                {% if asset.pk|stringformat:"s" not in request.session.mixed_sale_assets|default:'' %}
                                    <button class="btn btn-sm btn-info add-to-cart-btn" 
                                            data-asset-id="{{ asset.pk }}" 
                                            data-action="add"                                       data-add-url="{% url 'add_to_mixed_sale' %}"            data-remove-url="{% url 'remove_from_mixed_sale' %}">   Add to Cart
                                    </button>
                            {% else %}
                                <button class="btn btn-sm btn-danger remove-from-cart-btn" 
                                        data-asset-id="{{ asset.pk }}" 
                                        data-action="remove"
                                        data-add-url="{% url 'add_to_mixed_sale' %}" 
                                        data-remove-url="{% url 'remove_from_mixed_sale' %}"> 
                                    Remove ‚úñÔ∏è
                                </button>
                            {% endif %}
                            {% else %}
                                <button class="btn btn-sm btn-secondary" disabled>Unavailable</button>
                            {% endif %} 
                        </td>
                        
                        <td><a href="{% url 'asset_detail' asset_pk=asset.pk %}" class="btn btn-sm btn-outline-info">View Details</a></td>
                    </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center">No assets found matching the current filters.</td>
                </tr>
                {% endfor %} 
                </tbody> 
            </table>
        </div>

    </div> ¬† ¬† {% if assets.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if assets.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&{{ request.GET.urlencode|cut:'page=' }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">First</span></li>
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                <li class="page-item active" aria-current="page">
                    <span class="page-link">Page {{ assets.number }} of {{ assets.paginator.num_pages }}</span>
                </li>

                {% if assets.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ assets.paginator.num_pages }}&{{ request.GET.urlencode|cut:'page=' }}">Last</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    <li class="page-item disabled"><span class="page-link">Last</span></li>
                {% endif %}
            </ul>
        </nav>
    {% elif assets %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item active"><span class="page-link">Page 1 of 1</span></li>
            </ul>
        </nav>
    {% endif %}


    <div class="floating-cart-widget shadow d-flex align-items-center" id="floating-cart-widget" 
        {% if mixed_sale_count == 0 %}style="opacity: 0; pointer-events: none;"{% endif %}>
        
        <i class="bi bi-cart-fill me-2 fs-5"></i> <span class="badge rounded-pill me-2" id="cart-item-count">{{ mixed_sale_count }}</span>
        <span class="me-3">Items for Mixed Sale</span>
        <a href="{% url 'finalize_mixed_sale' %}" class="btn btn-sm btn-warning">Finalize Sale</a>
    </div>
{% endblock content %} 


{% block extra_js %} 
<script>
¬† ¬† // CSRF Token setup for AJAX
¬† ¬† // NOTE: The CSRF token needs to be included in your base.html for this to work.
¬† ¬† 

¬† ¬† document.addEventListener('DOMContentLoaded', function() {
    
    const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

    const cartWidget = document.getElementById('floating-cart-widget');
    const cartCount = document.getElementById('cart-item-count');

    // Selects both Add and Remove buttons
    document.querySelectorAll('.add-to-cart-btn, .remove-from-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (!csrfToken) {
                console.error("CSRF token not found. Cannot perform AJAX request.");
                return;
            }
            
            const assetId = this.dataset.assetId;
            const action = this.dataset.action;
            
            // Determine the URL based on the action
            const url = (action === 'add') ? this.dataset.addUrl : this.dataset.removeUrl;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ asset_pk: assetId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state (Add -> Remove, or Remove -> Add)
                    const newAction = (action === 'add') ? 'remove' : 'add';
                    const newClass = (newAction === 'add') ? 'btn-info add-to-cart-btn' : 'btn-danger remove-from-cart-btn';
                    const newText = (newAction === 'add') ? 'Add to Cart' : 'Remove ‚úñÔ∏è';
                    const newUrl = (newAction === 'add') ? this.dataset.addUrl : this.dataset.removeUrl;
                    
                    // Re-render button properties
                    this.className = `btn btn-sm ${newClass}`;
                    this.dataset.action = newAction;
                    this.innerHTML = newText;
                    
                    // Handle URL replacement if necessary (though the old ones are kept as data-* attributes)
                    
                    // Update the floating cart widget
                    cartCount.textContent = data.mixed_sale_count;
                    
                    if (data.mixed_sale_count > 0) {
                        cartWidget.style.opacity = 1;
                        cartWidget.style.pointerEvents = 'auto';
                    } else {
                        cartWidget.style.opacity = 0;
                        cartWidget.style.pointerEvents = 'none';
                    }

                    // Display a temporary success message
                    const tempMessage = document.createElement('div');
                    tempMessage.className = 'alert alert-success fixed-top m-3';
                    tempMessage.textContent = data.message;
                    document.body.appendChild(tempMessage);
                    setTimeout(() => tempMessage.remove(), 3000); 

                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});
</script>
{% endblock extra_js %}